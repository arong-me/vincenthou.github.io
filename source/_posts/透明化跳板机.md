# 背景

最近由于运维升级，原来可以直接连接到stage server，现在需要多一步，通过先登录到跳板机，再从跳板机登录到stage server，实在是太麻烦了，找到解决方案记录一下。
# 操作步骤
## 生成公钥私钥文件

一般用git的话，这个文件应该是生成过的，在用户目录的.ssh文件夹下面，没有的话自己生成一份

``` bash
ssh-keygen -t rsa
```

之前连接stage server，是限制在.ssh下authorized_keys文件中添加自己的公钥的，都是连接的时候带上私钥的

``` bash
ssh -i ~/.ssh/cp_key/id_rsa user@stage_ip
```

今天连上去看了下，只有我比较“守规矩”，里面添加了不少个人的公钥，我也就默默的加上去了，这样我们后续连接就轻松许多。
## 在跳板机和目标机（stage server）添加本地公钥

跳板机可以直接连，使用ssh-copy-id工具

``` bash
ssh-copy-id -i ~/.ssh/id_rsa.pub jump_server_ip
```

如果失败可以手动添加（stage server不能直接连，只能手动添加）：连接到要添加公钥的机器，进入用户目录的.ssh文件夹，打开authorized_keys文件，在文件末尾添加自己本地的公钥id_rsa.pub中的内容（一定要是在一行的），拷贝粘帖就搞定了。
## 隐藏跳板机

在.ssh文件夹下面创建config文件，添加以下内容

``` bash
Host stage
    ProxyCommand ssh user@jump_server_ip nc stage_server_ip %p
```

这个隐藏实际是通过ProxyCommand，可以在开启ssh之前执行一个命令打开代理隧道。
## 连接测试

配置搞定后我们就来连一下吧

``` bash
ssh stage
```

一下就来到stage server 的用户目录了，还可以方便的上传文件

``` bash
scp project.zip user@stage:~/tmp
```
# 参考资料

[SSH免密码登陆以及穿越跳板机](http://www.cnblogs.com/lucantang/p/3315329.html)
[有跳板机的 ssh 登陆](http://wdicc.com/controlmaster-in-ssh/)
[SSH自动穿越跳板机 ](http://blog.sina.com.cn/s/blog_677fbc19010179kv.html)
